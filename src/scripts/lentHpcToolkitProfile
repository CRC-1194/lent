#! /usr/bin/bash

# README

# READ README in lentHpcToolkitSetup.

# The prerequisite of this struct is to execute lentHpcToolkitSetup once each
# time the OpenFOAM platform is updated and compiled.

# This script runs `hpcrun`, and then uses `hpcstruct` to create the struct file
# of the `liblent.so` library. The `LENT_PROJECT` environmental variable is then
# used by `hpcprof` to find source files more easily. The `*.hpcstruct` files of
# OpenFOAM libraries generated by `lentHpcToolkitSetup` are re-used to save time
# in generating the profile. 

APPLICATION=$1
EVENTS=$2
MEASUREMENTS=$3


# Creating structures for the profiled application and liblent.so

echo "/usr/bin/time hpcrun -o $MEASUREMENTS $EVENTS $APPLICATION"
hpcrun -o $MEASUREMENTS $EVENTS $APPLICATION 

echo "/usr/bin/time hpcstruct -I $LENT_PROJECT/+ $(which  "$APPLICATION")"
hpcstruct -I $LENT_PROJECT/+ $(which  "$APPLICATION") 

# Profiling 
STRUCTS=$(ls $WM_PROJECT_DIR/build/*.hpcstruct)
STRUCTS=${STRUCTS//\/home/-S \/home}

echo "/usr/bin/time hpcstruct -I $LENT_PROJECT/+ $FOAM_USER_LIBBIN/liblent.so"
hpcstruct -I $LENT_PROJECT/+ $FOAM_USER_LIBBIN/liblent.so 

echo "/usr/bin/time hpcprof -o database-$MEASUREMENTS -S $APPLICATION.hpcstruct -S liblent.so.hpcstruct
$STRUCTS -I $LENT_PROJECT/+ $MEASUREMENTS"

hpcprof -o database-$MEASUREMENTS -S $APPLICATION.hpcstruct -S liblent.so.hpcstruct \
    $STRUCTS -I $LENT_PROJECT/+ $MEASUREMENTS
